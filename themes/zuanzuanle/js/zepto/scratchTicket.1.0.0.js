(function(){function e(e){e=$.extend({element:"#scratch_canvas",img:"",color:"#7d838b",fingerWidth:"30",threshold:.5},e),this.$ele=$(e.element),this.ele=this.$ele[0],this.config=e;var t=this.ele.getContext("2d");t.lineWidth=e.fingerWidth,t.lineCap=t.lineJoin="round",t.strokeStyle="black",this.ctx=t,this._eventEle=$({}),this._init()}$.extend(e.prototype,{_init:function(){this._drawImage(),this._bindEvents()},_drawImage:function(){var e=this,t=e.config.img,n,r=e.ele.width;height=e.ele.height,e.ctx.globalCompositeOperation="source-over",e.ctx.fillStyle=e.config.color,e.ctx.fillRect(0,0,r,height);if(!t)return;typeof t=="string"?(n=new Image,n.crossOrigin="*",n.onload=function(){e.ctx.drawImage(n,0,0,r,height),e._forceRepaint()},n.src=t):(n=t,e.ctx.drawImage(n,0,0,r,height)),e._forceRepaint()},_bindEvents:function(){function e(e){e.preventDefault();var t=n._getCoors(e);n._scratchLine(t.x,t.y)}function t(){n.ctx.closePath();var i=n.getScratchRatio();i>n.config.threshold&&!n.__scratched&&(n.trigger("scratchoff"),n.__scratched=!0),r.off("touchmove",e),r.off("touchend",t)}var n=this,r=$("body");n.$ele.on("touchstart",function(i){n.offset=n.$ele.offset();var s=n._getCoors(i);n._scratchLine(s.x,s.y,!0),r.on("touchmove",e),r.on("touchend",t)})},_scratchLine:function(e,t,n){n&&(this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.moveTo(e+.01,t)),this.ctx.lineTo(e,t),this.ctx.stroke(),this._forceRepaint()},_getCoors:function(e){var t,n={},r=this.offset;return(t=e.changedTouches[0])?(n.pageX=t.pageX,n.pageY=t.pageY):(n.pageX=e.pageX,n.pageY=e.pageY),{x:n.pageX-r.left,y:n.pageY-r.top}},_forceRepaint:function(){this.$ele.css("color")==="red"?this.$ele.css("color","black"):this.$ele.css("color","red")},getScratchRatio:function(){var e=this.ctx.getImageData(0,0,this.ele.width,this.ele.height),t=e.data,n=4,r=t.length/4,i=0;for(var s=0;s<t.length;s+=n)t[s]!=0&&i++;return 1-i/r},refresh:function(){this._drawImage(),this.__scratched=!1},clear:function(){this.ctx.globalCompositeOperation="destination-out",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.ele.width,this.ele.height),this.__scratched=!0,this._forceRepaint()},on:function(){this._eventEle.on.apply(this._eventEle,arguments)},off:function(){this._eventEle.off.apply(this._eventEle,arguments)},trigger:function(){this._eventEle.trigger.apply(this._eventEle,arguments)}}),this.ScratchTicket=e})();